#!/usr/bin/env python3
import os
import subprocess
import yaml
import argparse

BASE_DIR = "/tmp/qemu-compose"


def ensure_dirs():
    os.makedirs(BASE_DIR, exist_ok=True)
    os.makedirs(f"{BASE_DIR}/logs", exist_ok=True)


def load_yaml(path):
    with open(path, "r") as f:
        return yaml.safe_load(f)


def kvm_available():
    return os.path.exists("/dev/kvm")


def build_qemu_command(name, conf):
    arch = conf.get("arch", "x86_64")
    machine = conf.get("machine", "q35")
    cpus = conf.get("cpus", 2)
    cpu_model = conf.get("cpu_model", "max")  # safe default
    memory = conf.get("memory", 2048)

    # Detect KVM
    if arch == "x86_64" and kvm_available():
        accel = "kvm"
        cpu_model = "host"
    else:
        accel = "tcg"  # fallback

    cmd = [
        f"qemu-system-{arch}",
        "-accel", accel,
        "-machine", machine,
        "-smp", str(cpus),
        "-m", str(memory),
        "-cpu", cpu_model,
        "-display", "gtk",
    ]

    # ------------------------
    # NETWORKS
    # ------------------------
    net_id = 0
    if "networks" in conf:
        for net in conf["networks"]:
            if net["type"] == "user":
                net_id += 1
                forwards = net.get("forwards", [])
                fwd_str = ",".join(
                    [f"hostfwd=tcp::{f['host_port']}-:{f['guest_port']}" for f in forwards]
                )

                netdev = f"user,id=net{net_id}"
                if fwd_str:
                    netdev += f",{fwd_str}"

                cmd += [
                    "-netdev", netdev,
                    "-device", f"virtio-net-pci,netdev=net{net_id}"
                ]

    # ------------------------
    # DISKS
    # ------------------------
    if "disks" in conf:
        for d in conf["disks"]:
            path = d["path"]
            fmt = d.get("format", "qcow2")
            iface = d.get("interface", "virtio")
            cmd += ["-drive", f"file={path},format={fmt},if={iface}"]

    # ------------------------
    # CDROM / ISO
    # ------------------------
    if "cdrom" in conf:
        iso_path = conf["cdrom"]["path"]
        interface = conf["cdrom"].get("interface", "ide")
        cmd += ["-drive", f"file={iso_path},media=cdrom,if={interface}"]

    # ------------------------
    # MONITOR SOCKET
    # ------------------------
    monitor_path = f"{BASE_DIR}/{name}.monitor"
    cmd += ["-monitor", f"unix:{monitor_path},server=on,wait=off"]

    return cmd


def start_vm(name, conf):
    ensure_dirs()
    cmd = build_qemu_command(name, conf)
    log_file = f"{BASE_DIR}/logs/{name}.log"

    print(f"Starting {name} ...")
    print(" ".join(cmd))

    with open(log_file, "w") as lf:
        process = subprocess.Popen(cmd, stdout=lf, stderr=lf)

    print(f"{name} started (pid={process.pid}) logs -> {log_file}")


def stop_vm(name):
    monitor_path = f"{BASE_DIR}/{name}.monitor"
    if not os.path.exists(monitor_path):
        print("VM not running or monitor socket missing.")
        return

    try:
        subprocess.run(
            ["socat", "-", f"unix-connect:{monitor_path}"],
            input="system_powerdown\n",
            text=True
        )
        print(f"{name} stopped.")
    except FileNotFoundError:
        print("Install socat: sudo apt install socat")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("action", choices=["up", "down"])
    parser.add_argument("-f", "--file", default="qemu-compose.yml")
    args = parser.parse_args()

    data = load_yaml(args.file)
    vms = data.get("vms", {})

    for name, conf in vms.items():
        if args.action == "up":
            start_vm(name, conf)
        elif args.action == "down":
            stop_vm(name)


if __name__ == "__main__":
    main()
